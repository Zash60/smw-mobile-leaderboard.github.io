<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMW Speedrun Mobile</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #1a1a1a; color: #f0f0f0; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; }
        header { text-align: center; margin-bottom: 20px; }
        .main-nav { display: flex; justify-content: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .main-nav > button { background: #333; color: white; border: none; padding: 10px 20px; margin: 0 5px; cursor: pointer; font-size: 16px; border-radius: 5px; }
        .main-nav > button.active { background: #555; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .extension-toggle-container { text-align: center; margin-bottom: 20px; }
        #extension-toggle-btn { background-color: #3e3e3e; color: #ddd; border: 1px solid #555; padding: 6px 12px; border-radius: 5px; font-size: 0.9em; cursor: pointer; }
        #extension-toggle-btn:hover { background-color: #555; }
        #smw-categories-container, #smwext-categories-container { margin-bottom: 20px; }
        .categories-nav { display: flex; flex-wrap: wrap; justify-content: center; background-color: #252525; border-radius: 8px; padding: 5px; margin-bottom: 10px; }
        .categories-nav button { background-color: transparent; color: #ccc; border: none; padding: 10px 15px; cursor: pointer; font-size: 14px; border-radius: 5px; }
        .categories-nav button.active { background-color: #4a4a4a; color: #fff; font-weight: bold; }
        #smwext-category-select { background-color: #252525; color: white; border: 1px solid #555; padding: 10px; border-radius: 5px; width: 100%; font-size: 1em; }
        .leaderboard-list, .submission-list { list-style: none; padding: 0; }
        .leaderboard-list li { background: #2a2a2a; margin-bottom: 8px; padding: 15px; border-radius: 5px; display: flex; align-items: center; gap: 15px; }
        .leaderboard-list .rank { font-weight: bold; font-size: 1.2em; color: #888; min-width: 25px; text-align: right; }
        .leaderboard-list .player-info { flex-grow: 1; }
        .leaderboard-list .run-details { color: #aaa; font-size: 0.9em; }
        .leaderboard-list .run-time { font-weight: bold; font-size: 1.1em; }
        .yt-link { margin-left: 8px; text-decoration: none; vertical-align: middle; }
        .loader { text-align: center; padding: 20px; font-size: 1.5em; }
        button { cursor: pointer; }
        .submit-run-btn { display: block; width: 200px; margin: 20px auto; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #2a2a2a; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .modal-content label { color: #ccc; margin-bottom: -10px; }
        .modal-content input, .modal-content select { padding: 10px; border-radius: 3px; border: 1px solid #444; background: #333; color: white; font-size: 16px; width: 100%; box-sizing: border-box;}
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .submission-item { background-color: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #ffc107; }
        .submission-item.status-verified { border-left-color: #28a745; }
        .submission-item.status-rejected { border-left-color: #dc3545; }
        .submission-actions button { margin-right: 10px; padding: 8px 12px; border: none; border-radius: 4px; color: white; font-size: 14px; }
        .btn-verify { background-color: #28a745; }
        .btn-reject { background-color: #6c757d; }
        .btn-edit { background-color: #ffc107; color: black; }
        .btn-delete { background-color: #dc3545; }
    </style>
</head>
<body>

    <div class="container">
        <header><h1>SMW Speedrun Mobile</h1></header>
        <nav class="main-nav">
            <button onclick="showTab('home')" id="home-btn" class="active">Home</button>
            <button onclick="showTab('mod')" id="mod-btn">Mod</button>
        </nav>
        
        <div class="extension-toggle-container">
            <button id="extension-toggle-btn" onclick="toggleGame()"></button>
        </div>

        <div id="home" class="tab-content active">
            <div id="smw-categories-container">
                <div id="main-categories-nav" class="categories-nav"></div>
                <div id="sub-categories-nav" class="categories-nav"></div>
            </div>

            <div id="smwext-categories-container" style="display: none;">
                <select id="smwext-category-select" onchange="loadLeaderboardFromDropdown(this)"></select>
            </div>
            
            <h2 id="leaderboard-title" style="text-align: center;">Leaderboard</h2>
            <button class="submit-run-btn" onclick="openSubmitModal()">Submit Run</button>
            <div id="leaderboard-container">
                <div id="leaderboard-loader" class="loader">Select a category</div>
                <ul id="leaderboard-list" class="leaderboard-list"></ul>
            </div>
        </div>

        <div id="mod" class="tab-content">
            <div id="login-container">
                <form id="login-form" onsubmit="login(event)">
                    <h2>Moderator Login</h2>
                    <input type="email" id="email" placeholder="Email" required>
                    <input type="password" id="password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
            </div>
            <div id="mod-panel" style="display: none;">
                <h2 style="text-align:center">Moderation Panel</h2>
                <div class="mod-filters">
                    <button id="filter-pending" onclick="loadSubmissions('pending')" class="active">Pending</button>
                    <button id="filter-verified" onclick="loadSubmissions('verified')">Verified</button>
                    <button id="filter-rejected" onclick="loadSubmissions('rejected')">Rejected</button>
                </div>
                <div id="submission-list-container" class="submission-list"></div>
                <button id="logout-btn" onclick="logout()" style="display:block; margin: 20px auto; background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Logout</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="submit-run-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('submit-run-modal')">&times;</span>
            <h2>Submit New Run</h2>
            <form id="submit-run-form" onsubmit="submitRun(event)">
                <label for="submit-main-category">Category:</label>
                <select id="submit-main-category" onchange="updateSubCategoryDropdown('submit')"></select>
                <label for="submit-sub-category">Subcategory:</label>
                <select id="submit-sub-category"></select>
                <label for="player-name">Your Nickname:</label>
                <input type="text" id="player-name" required>
                <label for="run-time">Time (e.g., 9m 42s 440ms):</label>
                <input type="text" id="run-time" required>
                <label for="run-date">Date of Run:</label>
                <input type="date" id="run-date" required>
                <label for="video-url">Video URL:</label>
                <input type="url" id="video-url" placeholder="https://youtu.be/..." required>
                <button type="submit" style="background-color:#007bff">Submit for Verification</button>
            </form>
        </div>
    </div>
    
    <div id="edit-run-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('edit-run-modal')">&times;</span>
            <h2>Edit Run</h2>
            <form id="edit-run-form" onsubmit="saveEditedRun(event)">
                <input type="hidden" id="edit-run-id">
                <label for="edit-main-category">Category:</label>
                <select id="edit-main-category" onchange="updateSubCategoryDropdown('edit')"></select>
                <label for="edit-sub-category">Subcategory:</label>
                <select id="edit-sub-category"></select>
                <label for="edit-player-name">Player:</label>
                <input type="text" id="edit-player-name" required>
                <label for="edit-run-time">Time:</label>
                <input type="text" id="edit-run-time" required>
                <label for="edit-run-date">Date:</label>
                <input type="date" id="edit-run-date" required>
                <label for="edit-video-url">Video URL:</label>
                <input type="url" id="edit-video-url" required>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getDatabase, ref, push, onValue, update, set, get, query, orderByChild, equalTo, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBoH4wSUIA3y57Qv_uPaELmzuNNffSU9x4",
        authDomain: "smw-speedrun-mobile.firebaseapp.com",
        databaseURL: "https://smw-speedrun-mobile-default-rtdb.firebaseio.com",
        projectId: "smw-speedrun-mobile",
        storageBucket: "smw-speedrun-mobile.firebasestorage.app",
        messagingSenderId: "1051268583534",
        appId: "1:1051268583534:web:c813c2b8b28cb5fea1567f"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);
      
      let allCategoriesData = [];
      let currentCategorySelection = null;
      let currentGameId = 'smw';
      const apiBaseUrl = `https://www.speedrun.com/api/v1`;

      window.toggleGame = function() {
          currentGameId = (currentGameId === 'smw') ? 'smwext' : 'smw';
          updateGameUI();
          fetchAndDisplayCategories();
      }

      function updateGameUI() {
          const isMainGame = currentGameId === 'smw';
          const toggleBtn = document.getElementById('extension-toggle-btn');
          
          toggleBtn.textContent = isMainGame ? 'View Category Extensions' : 'View Main Categories';
          document.getElementById('smw-categories-container').style.display = isMainGame ? 'block' : 'none';
          document.getElementById('smwext-categories-container').style.display = isMainGame ? 'none' : 'block';
          
          document.getElementById('leaderboard-list').innerHTML = '';
          document.getElementById('leaderboard-title').textContent = 'Leaderboard';
          document.getElementById('leaderboard-loader').textContent = 'Select a category';
          currentCategorySelection = null;
      }

      async function fetchAndDisplayCategories() {
          const loader = document.getElementById('leaderboard-loader');
          loader.textContent = 'Loading categories...';
          loader.style.display = 'block';
          allCategoriesData = [];

          try {
              const response = await fetch(`${apiBaseUrl}/games/${currentGameId}/categories?embed=variables`);
              const data = await response.json();
              allCategoriesData = data.data;
              loader.textContent = 'Select a category';

              if (currentGameId === 'smw') {
                  displaySmwCategories();
              } else {
                  displaySmwExtCategories();
              }
          } catch (error) {
              console.error('Error fetching categories:', error);
              loader.textContent = 'Failed to load categories.';
          }
      }

      function displaySmwCategories() {
          const mainCategoriesNav = document.getElementById('main-categories-nav');
          mainCategoriesNav.innerHTML = '';
          if (allCategoriesData.length > 0) {
              allCategoriesData.forEach((category, index) => {
                  const button = document.createElement('button');
                  button.textContent = category.name;
                  button.onclick = () => selectMainCategory(category.id);
                  mainCategoriesNav.appendChild(button);
                  if (index === 0) selectMainCategory(category.id);
              });
          }
      }

      function displaySmwExtCategories() {
          const select = document.getElementById('smwext-category-select');
          select.innerHTML = '';
          if (allCategoriesData.length > 0) {
              allCategoriesData.forEach(category => {
                  const subVar = category.variables.data.find(v => v['is-subcategory']);
                  if (subVar) {
                      Object.entries(subVar.values.values).forEach(([valueId, valueData]) => {
                          const option = new Option(`${category.name} - ${valueData.label}`);
                          option.dataset.categoryId = category.id;
                          option.dataset.variableId = subVar.id;
                          option.dataset.valueId = valueId;
                          select.appendChild(option);
                      });
                  } else {
                      const option = new Option(category.name);
                      option.dataset.categoryId = category.id;
                      select.appendChild(option);
                  }
              });
              loadLeaderboardFromDropdown(select);
          }
      }

      window.loadLeaderboardFromDropdown = function(selectElement) {
          const selectedOption = selectElement.options[selectElement.selectedIndex];
          const { categoryId, variableId, valueId } = selectedOption.dataset;
          const title = selectedOption.textContent;
          loadLeaderboard(categoryId, variableId || null, valueId || null, title);
      }

      function parseTimeToMilliseconds(timeStr) {
          if (!timeStr || typeof timeStr !== 'string') return 0;
          let totalMs = 0;
          const hourMatch = timeStr.match(/(\d+)\s*h/);
          const minMatch = timeStr.match(/(\d+)\s*m(?!s)/);
          const secMatch = timeStr.match(/(\d+(\.\d+)?)\s*s/);
          const msMatch = timeStr.match(/(\d+)\s*ms/);
          if (hourMatch || minMatch || secMatch || msMatch) {
              if (hourMatch) totalMs += parseInt(hourMatch[1]) * 3600000;
              if (minMatch) totalMs += parseInt(minMatch[1]) * 60000;
              if (secMatch) totalMs += parseFloat(secMatch[1]) * 1000;
              if (msMatch) totalMs += parseInt(msMatch[1]);
              return totalMs;
          }
          const parts = timeStr.split(':');
          if (parts.length === 3) {
              totalMs += parseInt(parts[0]) * 3600000;
              totalMs += parseInt(parts[1]) * 60000;
              totalMs += parseFloat(parts[2]) * 1000;
          } else if (parts.length === 2) {
              totalMs += parseInt(parts[0]) * 60000;
              totalMs += parseFloat(parts[1]) * 1000;
          }
          return totalMs;
      }

      function loadLeaderboard(categoryId, variableId, valueId, title) {
          currentCategorySelection = { categoryId, variableId, valueId, title };
          const leaderboardList = document.getElementById('leaderboard-list');
          const leaderboardTitle = document.getElementById('leaderboard-title');
          const loader = document.getElementById('leaderboard-loader');
          leaderboardTitle.textContent = title;
          leaderboardList.innerHTML = '';
          loader.style.display = 'block';
          loader.textContent = 'Loading leaderboard...';

          let dbPath = `games/${currentGameId}/leaderboards/${categoryId}`;
          if (variableId && valueId) dbPath += `/${variableId}/${valueId}`;
          
          onValue(ref(database, dbPath), (snapshot) => {
              loader.style.display = 'none';
              leaderboardList.innerHTML = '';
              const data = snapshot.val();
              if (data) {
                  const runs = Object.values(data);
                  runs.sort((a, b) => parseTimeToMilliseconds(a.time) - parseTimeToMilliseconds(b.time));
                  
                  runs.forEach((run, index) => {
                      const li = document.createElement('li');
                      const youtubeIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.582,6.186 C21.328,5.247 20.753,4.672 19.814,4.418 C18.109,4 12,4 12,4 C12,4 5.891,4 4.186,4.418 C3.247,4.672 2.672,5.247 2.418,6.186 C2,7.891 2,12 2,12 C2,12 2,16.109 2.418,17.814 C2.672,18.753 3.247,19.328 4.186,19.582 C5.891,20 12,20 12,20 C12,20 18.109,20 19.814,19.582 C20.753,19.328 21.328,18.753 21.582,17.814 C22,16.109 22,12 22,12 C22,12 22,7.891 21.582,6.186 Z" fill="#FF0000"/><path d="M9.75,15.5 L15.75,12 L9.75,8.5 L9.75,15.5 Z" fill="white"/></svg>`;
                      const youtubeLink = run.videoUrl ? `<a href="${run.videoUrl}" target="_blank" class="yt-link" title="Watch video">${youtubeIcon}</a>` : '';
                      
                      li.innerHTML = `
                          <strong class="rank">#${index + 1}</strong>
                          <div class="player-info">
                              <span>${run.player} ${youtubeLink}</span>
                              <div class="run-details">${run.date}</div>
                          </div>
                          <strong class="run-time">${run.time}</strong>
                      `;
                      leaderboardList.appendChild(li);
                  });
              } else {
                  leaderboardList.innerHTML = '<li style="justify-content: center;">No runs submitted for this category yet.</li>';
              }
          });
      }
      
      window.closeModal = (modalId) => { document.getElementById(modalId).style.display = 'none'; }
      
      window.openSubmitModal = function() {
          if (!allCategoriesData.length) {
              alert("Categories are still loading, please wait.");
              return;
          }
          populateCategoryDropdowns('submit', currentCategorySelection);
          document.getElementById('submit-run-modal').style.display = 'block';
      }

      window.submitRun = async function(event) {
          event.preventDefault();
          const mainCatSelect = document.getElementById('submit-main-category');
          const subCatSelect = document.getElementById('submit-sub-category');
          
          const categoryData = allCategoriesData.find(c => c.id === mainCatSelect.value);
          const subcategoryVariable = categoryData.variables.data.find(v => v['is-subcategory']);
          const subcategoryValue = subcategoryVariable?.values.values[subCatSelect.value];
          
          const runData = {
              player: document.getElementById('player-name').value,
              time: document.getElementById('run-time').value,
              date: document.getElementById('run-date').value,
              videoUrl: document.getElementById('video-url').value,
              status: 'pending',
              submittedAt: new Date().toISOString(),
              category: { id: categoryData.id, name: categoryData.name },
              subcategory: subcategoryValue ? { variableId: subcategoryVariable.id, valueId: subCatSelect.value, name: subcategoryValue.label } : null
          };
          
          try {
              const submissionsRef = ref(database, `games/${currentGameId}/submissions`);
              await push(submissionsRef, runData);
              alert('Run submitted for verification successfully!');
              closeModal('submit-run-modal');
              document.getElementById('submit-run-form').reset();
          } catch (error) {
              console.error("Error submitting run:", error);
              alert('Failed to submit run.');
          }
      }

      window.loadSubmissions = function(filterStatus) {
          document.querySelectorAll('.mod-filters button').forEach(btn => btn.classList.remove('active'));
          document.getElementById(`filter-${filterStatus}`).classList.add('active');

          const container = document.getElementById('submission-list-container');
          container.innerHTML = '<div class="loader">Loading submissions...</div>';
          
          const submissionsQuery = query(ref(database, `games/${currentGameId}/submissions`), orderByChild('status'), equalTo(filterStatus));
          onValue(submissionsQuery, (snapshot) => {
              container.innerHTML = '';
              const submissions = snapshot.val();
              if (!submissions || snapshot.size === 0) {
                  container.innerHTML = `<p style="text-align:center">No '${filterStatus}' submissions found.</p>`;
                  return;
              }
              
              Object.entries(submissions).forEach(([id, data]) => {
                  const item = document.createElement('div');
                  item.className = `submission-item status-${data.status}`;
                  let rejectButton = '';
                  if (data.status === 'pending' || data.status === 'verified') {
                      rejectButton = `<button class="btn-reject" onclick="updateRunStatus('${id}', 'rejected')">Reject</button>`;
                  }
                  
                  const categoryTitle = data.subcategory ? `${data.category.name} - ${data.subcategory.name}` : data.category.name;

                  item.innerHTML = `
                      <p><strong>Player:</strong> ${data.player} | <strong>Time:</strong> ${data.time} | <strong>Date:</strong> ${data.date}</p>
                      <p><strong>Category:</strong> ${categoryTitle}</p>
                      <p><strong>Video:</strong> <a href="${data.videoUrl}" target="_blank">Watch</a></p>
                      <div class="submission-actions">
                          ${data.status === 'pending' ? `<button class="btn-verify" onclick="verifyRun('${id}')">Approve</button>` : ''}
                          ${rejectButton}
                          <button class="btn-edit" onclick="openEditModal('${id}')">Edit</button>
                          <button class="btn-delete" onclick="deleteRun('${id}')">Delete</button>
                      </div>
                  `;
                  container.appendChild(item);
              });
          });
      }

      window.updateRunStatus = async (id, newStatus) => {
          const submissionRef = ref(database, `games/${currentGameId}/submissions/${id}`);
          try {
              const snapshot = await get(submissionRef);
              const data = snapshot.val();

              if (data && data.status === 'verified' && newStatus === 'rejected' && data.leaderboardKey) {
                  let leaderboardPath = `games/${currentGameId}/leaderboards/${data.category.id}`;
                  if (data.subcategory) leaderboardPath += `/${data.subcategory.variableId}/${data.subcategory.valueId}`;
                  leaderboardPath += `/${data.leaderboardKey}`;
                  
                  await remove(ref(database, leaderboardPath));
                  await update(submissionRef, { leaderboardKey: null }); 
              }

              await update(submissionRef, { status: newStatus });
              alert(`Run status changed to ${newStatus}.`);

          } catch (error) {
              console.error("Error updating run status:", error);
              alert("Failed to update run status.");
          }
      }

      window.verifyRun = async (id) => {
          const submissionRef = ref(database, `games/${currentGameId}/submissions/${id}`);
          const snapshot = await get(submissionRef);
          const data = snapshot.val();
          if (!data) return;
          
          let leaderboardPath = `games/${currentGameId}/leaderboards/${data.category.id}`;
          if(data.subcategory) leaderboardPath += `/${data.subcategory.variableId}/${data.subcategory.valueId}`;
          
          const newRunOnLeaderboardRef = await push(ref(database, leaderboardPath), {
              player: data.player,
              time: data.time,
              date: data.date,
              videoUrl: data.videoUrl || ''
          });
          
          await update(submissionRef, { 
              status: 'verified',
              leaderboardKey: newRunOnLeaderboardRef.key
          });
          alert('Run verified and added to the leaderboard!');
      }

      window.deleteRun = async (id) => {
          if (!confirm("Are you sure you want to permanently delete this run? This action cannot be undone.")) {
              return;
          }

          const submissionRef = ref(database, `games/${currentGameId}/submissions/${id}`);
          try {
              const snapshot = await get(submissionRef);
              const data = snapshot.val();

              if (data && data.status === 'verified' && data.leaderboardKey) {
                  let leaderboardPath = `games/${currentGameId}/leaderboards/${data.category.id}`;
                  if (data.subcategory) leaderboardPath += `/${data.subcategory.variableId}/${data.subcategory.valueId}`;
                  leaderboardPath += `/${data.leaderboardKey}`;
                  
                  await remove(ref(database, leaderboardPath));
              }

              await remove(submissionRef);
              alert('Run permanently deleted.');
          } catch (error) {
              console.error("Error deleting run:", error);
              alert("Failed to delete run.");
          }
      }
      
      window.openEditModal = async (id) => {
          const submissionRef = ref(database, `games/${currentGameId}/submissions/${id}`);
          const snapshot = await get(submissionRef);
          const data = snapshot.val();

          const selection = {
            categoryId: data.category.id,
            valueId: data.subcategory ? data.subcategory.valueId : null
          };

          document.getElementById('edit-run-id').value = id;
          populateCategoryDropdowns('edit', selection);
          document.getElementById('edit-player-name').value = data.player;
          document.getElementById('edit-run-time').value = data.time;
          document.getElementById('edit-run-date').value = data.date;
          document.getElementById('edit-video-url').value = data.videoUrl || '';
          document.getElementById('edit-run-modal').style.display = 'block';
      }
      
      window.saveEditedRun = async (event) => {
          event.preventDefault();
          const id = document.getElementById('edit-run-id').value;
          const mainCatSelect = document.getElementById('edit-main-category');
          const subCatSelect = document.getElementById('edit-sub-category');
          
          const categoryData = allCategoriesData.find(c => c.id === mainCatSelect.value);
          const subcategoryVariable = categoryData.variables.data.find(v => v['is-subcategory']);
          const subcategoryValue = subcategoryVariable?.values.values[subCatSelect.value];

          const updatedData = {
              player: document.getElementById('edit-player-name').value,
              time: document.getElementById('edit-run-time').value,
              date: document.getElementById('edit-run-date').value,
              videoUrl: document.getElementById('edit-video-url').value,
              category: { id: categoryData.id, name: categoryData.name },
              subcategory: subcategoryValue ? { variableId: subcategoryVariable.id, valueId: subCatSelect.value, name: subcategoryValue.label } : null
          };
          
          const submissionRef = ref(database, `games/${currentGameId}/submissions/${id}`);
          const snapshot = await get(submissionRef);
          const existingData = snapshot.val();
          Object.assign(existingData, updatedData);

          await set(submissionRef, existingData);
          alert('Run updated!');
          closeModal('edit-run-modal');
      }

      function populateCategoryDropdowns(prefix, selection) {
          const mainCatSelect = document.getElementById(`${prefix}-main-category`);
          mainCatSelect.innerHTML = '';
          allCategoriesData.forEach(cat => {
              const option = new Option(cat.name, cat.id);
              if (selection && cat.id === selection.categoryId) option.selected = true;
              mainCatSelect.appendChild(option);
          });
          updateSubCategoryDropdown(prefix, selection ? selection.valueId : null);
      }

      window.updateSubCategoryDropdown = function(prefix, selectedValueId = null) {
          const mainCatSelect = document.getElementById(`${prefix}-main-category`);
          const subCatSelect = document.getElementById(`${prefix}-sub-category`);
          subCatSelect.innerHTML = '';
          const category = allCategoriesData.find(c => c.id === mainCatSelect.value);
          const subcategoryVariable = category?.variables.data.find(v => v['is-subcategory']);

          if (subcategoryVariable) {
              Object.entries(subcategoryVariable.values.values).forEach(([valueId, valueData]) => {
                  const option = new Option(valueData.label, valueId);
                  if (selectedValueId && valueId === selectedValueId) option.selected = true;
                  subCatSelect.appendChild(option);
              });
              subCatSelect.style.display = 'block';
              subCatSelect.previousElementSibling.style.display = 'block';
          } else {
              subCatSelect.style.display = 'none';
              subCatSelect.previousElementSibling.style.display = 'none';
          }
      }

      window.showTab = function(tabName) {
          document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
          document.querySelectorAll('.main-nav button').forEach(btn => btn.classList.remove('active'));
          document.getElementById(tabName).classList.add('active');
          document.getElementById(`${tabName}-btn`).classList.add('active');
      }

      window.login = function(event) {
          event.preventDefault();
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          signInWithEmailAndPassword(auth, email, password).catch(error => alert("Login Error: " + error.message));
      }
      
      window.logout = function() {
          signOut(auth).catch(error => console.error("Logout Error:", error));
      }

      onAuthStateChanged(auth, (user) => {
          if (user) {
              document.getElementById('login-container').style.display = 'none';
              document.getElementById('mod-panel').style.display = 'block';
              loadSubmissions('pending');
          } else {
              document.getElementById('login-container').style.display = 'block';
              document.getElementById('mod-panel').style.display = 'none';
          }
      });
      
      document.addEventListener('DOMContentLoaded', () => {
          updateGameUI();
          fetchAndDisplayCategories();
      });

      function selectMainCategory(categoryId) {
          document.querySelectorAll('#main-categories-nav button').forEach(btn => {
              const category = allCategoriesData.find(c => c.id === categoryId);
              btn.classList.toggle('active', btn.textContent === category.name);
          });
          const subCategoriesNav = document.getElementById('sub-categories-nav');
          subCategoriesNav.innerHTML = '';
          const category = allCategoriesData.find(c => c.id === categoryId);
          const subcategoryVariables = category.variables.data.filter(v => v['is-subcategory']);
          if (subcategoryVariables.length > 0) {
              const variable = subcategoryVariables[0];
              Object.entries(variable.values.values).forEach(([valueId, valueData], index) => {
                  const button = document.createElement('button');
                  button.textContent = valueData.label;
                  button.onclick = () => selectSubCategory(categoryId, variable.id, valueId, button);
                  subCategoriesNav.appendChild(button);
                  if (index === 0) button.click();
              });
          } else {
              loadLeaderboard(categoryId, null, null, category.name);
          }
      }

      function selectSubCategory(categoryId, variableId, valueId, clickedButton) {
          document.querySelectorAll('#sub-categories-nav button').forEach(btn => btn.classList.remove('active'));
          clickedButton.classList.add('active');
          const category = allCategoriesData.find(c => c.id === categoryId);
          const title = `${category.name} - ${clickedButton.textContent}`;
          loadLeaderboard(categoryId, variableId, valueId, title);
      }
    </script>
</body>
</html>
